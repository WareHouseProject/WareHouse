<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<title>WareHouse MainGame</title>
</head>
<body>

  <script src="enchantjs/enchant.min.js"></script>
  <script src="js/jquery.min.js"></script>
  <script>
  $(document).ready(function(){
  	enchant();							// initialize

		var MAX_ROW = 8;//縦のマス数
		var MAX_COL = 10;//横のマス数
		var CELL_SIZE = 96;//1マスの大きさ
		var MAP_IMG = "Image/image.png";
		var Player_X = 0;//プレイヤー初期位置
		var Player_Y = 0;
		var MoveBox_X = 0;//移動箱の初期位置
		var MoveBox_Y = 0;

		var wall_hit = false;//壁に当たっているか

		var keyPush = false;//キーのトリガー機能用

  	var game = new Core(960, 768);		// game stage
  	//game.preload('Image/Board.png');		// preload image
		//game.preload('Image/Player.png');
		game.preload('Image/image.png');
		game.preload('Image/Square.png');
		game.preload('Image/c_52b/c_52b0.png');
		game.preload('Image/MoveBox.png');
  	game.fps = 20;

    game.onload = function(){

  	var scene = new Scene();
		var map = new Map(96,96);//フィールド描画
		//ステージデータ
		var fieldmap = [[1,1,1,1,1,1,1,1,1,1],
										[1,0,0,0,0,4,0,0,0,1],
										[1,0,0,0,0,0,0,0,0,1],
										[1,0,0,0,0,0,0,0,0,1],
										[1,0,0,2,0,0,0,0,0,1],
										[1,0,0,1,0,0,0,0,0,1],
										[1,0,0,1,0,0,3,0,0,1],
										[1,1,1,1,1,1,1,1,1,1],
		];

		//mapにキャラクター画像を読み込ませる
		map.image = game.assets[MAP_IMG];
		//mapにフィールドを読み込ませる
		map.loadData(fieldmap);

		scene.addChild(map);

		//マップデータからプレイヤーの番号を探して位置を保存
		for (var i = 0; i < MAX_COL; i++) {
			for (var j = 0; j < MAX_ROW; j++) {
				if(fieldmap[j][i] == 4){
						Player_X = i * 96;
						Player_Y = j * 96;
					}
					if(fieldmap[j][i] == 2){
							MoveBox_X = i * 96;
							MoveBox_Y = j * 96;
						}
				}
			}

		//プレイヤー準備
		var player = new Player(Player_X,Player_Y);
		scene.addChild(player);

		var moveBox = new MoveBox(MoveBox_X,MoveBox_Y);
		scene.addChild(moveBox);

  	//毎フレーム毎の処理
  	scene.addEventListener('enterframe', function(e) {

				//プレイヤーと箱の当たり判定
				//if(player.intersect(moveBox)){
				//	scene.removeChild(moveBox);
				//}

  			if (game.input.up    === true) player.walk("w", fieldmap);
  			else if (game.input.left  === true) player.walk("a", fieldmap);
  			else if (game.input.down  === true) player.walk("s", fieldmap);
  			else if (game.input.right === true) player.walk("d", fieldmap);
				else keyPush = false;

				map.loadData(fieldmap);

				for (var i = 0; i < MAX_COL; i++) {
					for (var j = 0; j < MAX_ROW; j++) {
							if(fieldmap[j][i] == 2){
									MoveBox_X = i * 96;
									MoveBox_Y = j * 96;
								}
						}
					}
				moveBox.move(MoveBox_X,MoveBox_Y);

  		});

  		//シーンを反映
          game.pushScene(scene);
        };

      game.start(); // start your game!

					//プレイヤークラス
					var Player = enchant.Class.create(Sprite, {		//Spriteクラスを継承
							/** コンストラクター */
							initialize: function(x,y) {
								var game = enchant.Game.instance;
								Sprite.call(this, 96, 96);					//Spriteのサイズ定義
								this.x = x;
								this.y = y;
								this.image = game.assets['Image/c_52b/c_52b0.png'];		//Spriteに画像をセット
							}

							/** 移動処理メソッド */
							, walk: function(key, fieldmap){
								if(keyPush) return;
								var step = 96;
								keyPush = true;

								this.hit(key, fieldmap);
								if(wall_hit) return;
								//移動
								switch(key){
									case 'w': this.y -= step; break;
									case 'a': this.x -= step; break;
									case 's': this.y += step; break;
									case 'd': this.x += step; break;
								}
								//SE再生
								//game.assets['sound/se_foot_short.mp3'].play();
							}
							//当たり判定
							, hit: function (direction, fieldmap){

								var col_num = 0;
								var row_num = 0;

								switch(direction){
									case 'w': row_num = -1; break;
									case 'a': col_num = -1; break;
									case 's': row_num = 1; break;
									case 'd': col_num = 1; break;
								}

								for (var i = 0; i < MAX_COL; i++) {
									for (var j = 0; j < MAX_ROW; j++) {
										//移動するブロックとの判定
										if(fieldmap[(this.y / 96) + row_num][(this.x / 96) + col_num] == 2
										&& fieldmap[(this.y / 96) + row_num*2][(this.x / 96) + col_num*2] == 0){
											//マップデータの書き換え
												fieldmap[(this.y / 96) + row_num][(this.x / 96) + col_num] = 0;
												fieldmap[(this.y / 96) + row_num*2][(this.x / 96) + col_num*2] = 2;
											return;
											}
											//動かない壁との判定
											if(fieldmap[(this.y / 96) + row_num][(this.x / 96) + col_num] == 2
											&& fieldmap[(this.y / 96) + row_num*2][(this.x / 96) + col_num*2] == 1){
												wall_hit = true;
												return;
												}
										//動かない壁との判定
										if(fieldmap[(this.y / 96) + row_num][(this.x / 96) + col_num] == 1){
											wall_hit = true;
											return;
											}
										}
									}
									wall_hit = false;
							}
					});

					var MoveBox = enchant.Class.create(Sprite, {
							initialize: function(x,y){
								var game = enchant.Game.instance;
								Sprite.call(this, 96, 96);
								this.x = x;
								this.y = y;
								this.image = game.assets['Image/MoveBox.png'];
							}

							, move: function(x,y){
								this.x = x;
								this.y = y;
							}

					});

          });
  </script>
</body>
</html>
